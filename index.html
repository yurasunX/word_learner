<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Learner TWA 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–æ–Ω TWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
            background-color: var(--tg-theme-bg-color, #f8fafc); 
            color: var(--tg-theme-text-color, #0f172a);
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }

        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .flip-card-back {
            transform: rotateY(180deg);
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom styles for TWA color dynamic */
        .bg-twa-primary {
            background-color: var(--tg-theme-button-color, #007bff);
        }
        .text-twa-primary {
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .border-twa-hint {
             border-color: var(--tg-theme-hint-color, #9ca3af);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 flex flex-col h-screen" style="padding-bottom: 64px; background-color: var(--tg-theme-bg-color, #f8fafc); color: var(--tg-theme-text-color, #0f172a);">

    <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">

        <div id="home-view" class="view active space-y-6">
            <h1 class="text-3xl font-bold text-slate-800" style="color: var(--tg-theme-text-color, #0f172a);">–ì–ª–∞–≤–Ω–∞—è</h1>
            <p class="text-slate-600" style="color: var(--tg-theme-hint-color, #475569);">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≤–∞—à –ª–∏—á–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä —Å–ª–æ–≤. –ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–±—É—á–µ–Ω–∏—é.</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                    <h3 class="text-lg font-semibold text-slate-500 mb-2" style="color: var(--tg-theme-hint-color, #64748b);">–í—Å–µ–≥–æ —Å–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ</h3>
                    <p id="home-total-words" class="text-4xl font-bold text-sky-600" style="color: var(--tg-theme-link-color, #0ea5e9);">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                    <h3 class="text-lg font-semibold text-slate-500 mb-2" style="color: var(--tg-theme-hint-color, #64748b);">–°–ª–æ–≤ –≤—ã—É—á–µ–Ω–æ</h3>
                    <p id="home-learned-words" class="text-4xl font-bold text-emerald-600">0</p>
                </div>
            </div>

            <div class="space-y-4">
                <button onclick="startLearn('flashcard')" class="w-full bg-sky-600 text-white font-semibold py-4 px-6 rounded-xl shadow-xl hover:bg-sky-700 transition-all text-lg flex items-center justify-center space-x-2">
                    <span>üß†</span>
                    <span>–ù–∞—á–∞—Ç—å (–ö–∞—Ä—Ç–æ—á–∫–∏)</span>
                </button>
                <button onclick="startLearn('quiz')" class="w-full bg-white text-sky-700 border-2 border-sky-600 font-semibold py-4 px-6 rounded-xl shadow-md hover:bg-sky-50 transition-all text-lg flex items-center justify-center space-x-2">
                    <span>‚úçÔ∏è</span>
                    <span>–ù–∞—á–∞—Ç—å (–í–∏–∫—Ç–æ—Ä–∏–Ω–∞)</span>
                </button>
                <button onclick="startLearn('typing')" class="w-full bg-white text-emerald-700 border-2 border-emerald-600 font-semibold py-4 px-6 rounded-xl shadow-md hover:bg-emerald-50 transition-all text-lg flex items-center justify-center space-x-2">
                    <span>üìù</span>
                    <span>–ù–∞–ø–∏—Å–∞–Ω–∏–µ –ü–µ—Ä–µ–≤–æ–¥–∞</span>
                </button>
                
                <hr class="border-slate-200">
                
                <button onclick="navigate('gpt-view')" class="w-full bg-indigo-600 text-white font-semibold py-4 px-6 rounded-xl shadow-xl hover:bg-indigo-700 transition-all text-lg flex items-center justify-center space-x-2">
                    <span>ü§ñ</span>
                    <span>GPT –ó–∞–¥–∞–Ω–∏—è (Advanced)</span>
                </button>
                <button onclick="requestDailyReminder()" class="w-full bg-slate-200 text-slate-800 font-semibold py-3 px-6 rounded-xl shadow-inner hover:bg-slate-300 transition-all text-sm flex items-center justify-center space-x-2">
                    <span>‚è∞</span>
                    <span>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ –ë–æ—Ç–∞)</span>
                </button>
            </div>
        </div>

        <div id="learn-view" class="view space-y-6">
            <h1 class="text-3xl font-bold text-slate-800">–¢—Ä–µ–Ω–∞–∂–µ—Ä</h1>
            <p class="text-slate-600">–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏—Ö.</p>

            <div id="no-words-message" class="hidden text-center p-6 rounded-xl shadow-md" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                <p class="text-xl font-semibold text-slate-700">–í –≤–∞—à–µ–º —Å–ª–æ–≤–∞—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤.</p>
                <p class="text-slate-500 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–î–æ–±–∞–≤–∏—Ç—å", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ.</p>
                <button onclick="navigate('add-view')" class="mt-4 bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-sky-700 transition-all">
                    –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞
                </button>
            </div>

            <div id="learn-container" class="space-y-4">
                <div id="flashcard-mode" class="hidden space-y-4">...</div>

                <div id="quiz-mode" class="hidden space-y-4">...</div>
                
                <div id="spelling-mode" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 text-center" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                        <p class="text-sm text-slate-500 mb-2">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥:</p>
                        <h2 id="spelling-question" class="text-3xl font-bold text-slate-800 mb-6"></h2>
                    </div>
                    <input type="text" id="spelling-input" class="w-full p-4 border-2 border-slate-300 rounded-lg text-lg focus:ring-sky-500" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º..." style="background-color: var(--tg-theme-secondary-bg-color, #ffffff); color: var(--tg-theme-text-color, #0f172a); border-color: var(--tg-theme-hint-color, #94a3b8);">
                    <button onclick="checkSpelling()" class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-all">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                    </button>
                    <div id="spelling-feedback" class="text-center font-semibold p-3 rounded-lg hidden"></div>
                    <button onclick="nextWord()" id="spelling-next-btn" class="w-full bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-sky-700 transition-all hidden">
                        –°–ª–µ–¥—É—é—â–µ–µ
                    </button>
                </div>
                
                <div id="typing-mode" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 text-center" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                        <p class="text-sm text-slate-500 mb-2">–ù–∞–ø–∏—à–∏—Ç–µ —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥:</p>
                        <h2 id="typing-question" class="text-3xl font-bold text-slate-800 mb-6"></h2>
                    </div>
                    <input type="text" id="typing-input" class="w-full p-4 border-2 border-slate-300 rounded-lg text-lg focus:ring-sky-500" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º..." style="background-color: var(--tg-theme-secondary-bg-color, #ffffff); color: var(--tg-theme-text-color, #0f172a); border-color: var(--tg-theme-hint-color, #94a3b8);">
                    <button onclick="checkTyping()" class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-all">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                    </button>
                    <div id="typing-feedback" class="text-center font-semibold p-3 rounded-lg hidden"></div>
                    <button onclick="nextWord()" id="typing-next-btn" class="w-full bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-sky-700 transition-all hidden">
                        –°–ª–µ–¥—É—é—â–µ–µ
                    </button>
                </div>
            </div>
        </div>
        
        <div id="dictionary-view" class="view space-y-6">...</div>

        <div id="add-view" class="view space-y-6">...</div>

        <div id="stats-view" class="view space-y-6">...</div>
        
        <div id="gpt-view" class="view space-y-6">
            <h1 class="text-3xl font-bold text-slate-800">GPT –ó–∞–¥–∞–Ω–∏—è</h1>
            <p class="text-slate-600">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Å–ª–æ–≤–∞ –±–æ—Ç—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∑–∞–¥–∞–Ω–∏–π –∏ –ø—Ä–∏–º–µ—Ä–æ–≤.</p>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 space-y-4" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff);">
                <p class="text-lg font-semibold text-slate-700">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?</p>
                
                <div class="space-y-3">
                    <label class="flex items-center space-x-3">
                        <input type="radio" name="gpt-task" value="sentences" checked class="form-radio text-sky-600 h-5 w-5">
                        <span class="text-slate-700">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="radio" name="gpt-task" value="story" class="form-radio text-sky-600 h-5 w-5">
                        <span class="text-slate-700">–ö–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑ —Å –º–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="radio" name="gpt-task" value="quiz" class="form-radio text-sky-600 h-5 w-5">
                        <span class="text-slate-700">–°–ª–æ–∂–Ω–∞—è –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</span>
                    </label>
                </div>
                
                <p class="text-sm text-red-500">
                    <span id="gpt-word-count-note"></span>
                </p>
                
                <button onclick="requestGPTTask()" id="request-gpt-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition-all disabled:opacity-50">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –±–æ—Ç—É (–Ω—É–∂–µ–Ω –±—ç–∫–µ–Ω–¥)
                </button>
            </div>
            
            <p id="gpt-feedback" class="text-center font-semibold p-3 rounded-lg hidden"></p>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-inner h-16 flex justify-around items-center" style="background-color: var(--tg-theme-secondary-bg-color, #ffffff); border-top-color: var(--tg-theme-secondary-bg-color, #f1f5f9);">
        <button data-view="home-view" class="nav-btn flex flex-col items-center justify-center text-sky-600 w-full" style="color: var(--tg-theme-hint-color, #94a3b8);">
            <span class="text-2xl">üè†</span>
            <span class="text-xs font-medium">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button data-view="learn-view" class="nav-btn flex flex-col items-center justify-center text-slate-500 w-full" style="color: var(--tg-theme-hint-color, #94a3b8);">
            <span class="text-2xl">üß†</span>
            <span class="text-xs font-medium">–£—á–∏—Ç—å</span>
        </button>
        <button data-view="dictionary-view" class="nav-btn flex flex-col items-center justify-center text-slate-500 w-full" style="color: var(--tg-theme-hint-color, #94a3b8);">
            <span class="text-2xl">üìö</span>
            <span class="text-xs font-medium">–°–ª–æ–≤–∞—Ä—å</span>
        </button>
        <button data-view="add-view" class="nav-btn flex flex-col items-center justify-center text-slate-500 w-full" style="color: var(--tg-theme-hint-color, #94a3b8);">
            <span class="text-2xl">‚ûï</span>
            <span class="text-xs font-medium">–î–æ–±–∞–≤–∏—Ç—å</span>
        </button>
        <button data-view="stats-view" class="nav-btn flex flex-col items-center justify-center text-slate-500 w-full" style="color: var(--tg-theme-hint-color, #94a3b8);">
            <span class="text-2xl">üìä</span>
            <span class="text-xs font-medium">–°—Ç–∞—Ç—É—Å</span>
        </button>
    </nav>

    <script>
        // *** 1. INIT & STORAGE IMPROVEMENTS (TWA Cloud Storage) ***
        let tg;
        const DB_KEY = 'wordLearnerDB_v2'; // Updated key for v2 storage
        let db = {
            words: [],
            stats: {
                learnedDaily: {},
            }
        };
        let state = {
            currentView: 'home-view',
            currentExercise: 'flashcard',
            currentWordIndex: 0,
            quizOptions: [],
            wordQueue: [],
            addMode: 'single' // 'single' or 'bulk'
        };
        
        let masteryChartInstance = null;
        let activityChartInstance = null;
        

        // Using TWA CloudStorage for cross-device persistence
        async function saveDB() {
            try {
                const data = JSON.stringify(db);
                if (tg && tg.CloudStorage) {
                    await tg.CloudStorage.setItem(DB_KEY, data);
                } else { // Fallback for testing outside TWA
                    localStorage.setItem(DB_KEY, data);
                }
            } catch (e) {
                console.error("Error saving DB", e);
            }
        }
        
        async function loadDB() {
            try {
                let data = null;
                if (tg && tg.CloudStorage) {
                    data = await tg.CloudStorage.getItem(DB_KEY);
                } else {
                    data = localStorage.getItem(DB_KEY);
                }

                if (data) {
                    const loadedDb = JSON.parse(data);
                    // Merge and ensure structure integrity
                    db.words = loadedDb.words || [];
                    db.stats = loadedDb.stats || { learnedDaily: {} };
                }
            } catch (e) {
                console.error("Error loading DB", e);
                db = { words: [], stats: { learnedDaily: {} } };
            }
        }
        
        // Helper function for navigating and updating active nav button color
        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                // Remove active TWA color style
                btn.style.color = 'var(--tg-theme-hint-color, #94a3b8)'; 
            });
            
            const activeBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
            if (activeBtn) {
                // Apply active TWA color style
                activeBtn.style.color = 'var(--tg-theme-link-color, #0ea5e9)'; 
            }
            
            state.currentView = viewId;
            
            // View specific logic
            if (viewId === 'home-view') {
                 renderHomeStats();
                 if(tg) tg.MainButton.hide();
            }
            if (viewId === 'dictionary-view') renderDictionary();
            if (viewId === 'stats-view') renderStatsCharts();
            if (viewId === 'add-view') setupAddWordView();
            if (viewId === 'gpt-view') setupGPTView();
            if (viewId === 'learn-view') {
                if(tg) tg.MainButton.hide();
            }
        }
        
        // *** 2. GPT INTEGRATION INTERFACE ***

        function setupGPTView() {
            const wordCount = db.words.length;
            const noteEl = document.getElementById('gpt-word-count-note');
            const btn = document.getElementById('request-gpt-btn');
            
            if (wordCount < 5) {
                noteEl.textContent = `–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏–π –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5 —Å–ª–æ–≤. –£ –≤–∞—Å: ${wordCount}.`;
                btn.disabled = true;
            } else {
                noteEl.textContent = `–í–∞—à –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ ${wordCount} —Å–ª–æ–≤–∞—Ö –∏–∑ —Å–ª–æ–≤–∞—Ä—è.`;
                btn.disabled = false;
            }
            document.getElementById('gpt-feedback').classList.add('hidden');
        }

        function requestGPTTask() {
            if (!tg || !tg.sendData) {
                alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Web App, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—â–µ–Ω –±–æ—Ç–æ–º —Å –±—ç–∫–µ–Ω–¥–æ–º.');
                return;
            }
            
            const selectedTask = document.querySelector('input[name="gpt-task"]:checked').value;
            const wordsForGPT = db.words.map(w => ({ eng: w.eng, rus: w.rus })).slice(0, 50); // Limit to 50 for safety
            const feedbackEl = document.getElementById('gpt-feedback');

            const payload = {
                action: 'REQUEST_GPT_TASK',
                taskType: selectedTask,
                words: wordsForGPT,
                user: tg.initDataUnsafe.user // Optional: pass user info for personalized response
            };

            // Send data to the bot backend
            tg.sendData(JSON.stringify(payload));
            
            feedbackEl.innerHTML = '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞—à–µ–º—É –±–æ—Ç—É. –û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ Telegram!';
            feedbackEl.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            feedbackEl.classList.add('bg-sky-100', 'text-sky-700');
            
            // Close TWA after a short delay for better user experience
            setTimeout(() => {
                tg.close();
            }, 3000);
        }
        
        // *** 3. REMINDER FUNCTIONALITY (TWA sendData) ***

        function requestDailyReminder() {
            if (!tg || !tg.sendData) {
                alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Web App, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—â–µ–Ω –±–æ—Ç–æ–º —Å –±—ç–∫–µ–Ω–¥–æ–º.');
                return;
            }
            
            // Send request to the bot to set a daily reminder using its internal scheduler
            const payload = {
                action: 'SET_DAILY_REMINDER',
                time: 'daily',
                user: tg.initDataUnsafe.user // Pass user info
            };
            
            tg.sendData(JSON.stringify(payload));
            
            // Show feedback and close
            alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
            tg.close();
        }

        // *** 4. NEW EXERCISE MODE: TYPING (Reverse Spelling) ***

        function checkTyping() {
            const input = document.getElementById('typing-input');
            const answer = input.value.trim().toLowerCase();
            const word = state.wordQueue[state.currentWordIndex];
            const correctAnswer = word.rus.toLowerCase();
            
            const feedbackEl = document.getElementById('typing-feedback');
            
            input.disabled = true;
            
            if (answer === correctAnswer) {
                feedbackEl.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                feedbackEl.className = 'text-center font-semibold p-3 rounded-lg bg-emerald-100 text-emerald-700';
                input.classList.remove('border-slate-300', 'border-red-500');
                input.classList.add('border-emerald-500');
                updateWordMastery(word.id, true);
            } else {
                feedbackEl.innerHTML = `–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>${word.rus}</b>`;
                feedbackEl.className = 'text-center font-semibold p-3 rounded-lg bg-red-100 text-red-700';
                input.classList.remove('border-slate-300', 'border-emerald-500');
                input.classList.add('border-red-500');
                updateWordMastery(word.id, false);
            }
            
            feedbackEl.classList.remove('hidden');
            document.getElementById('typing-next-btn').classList.remove('hidden');
            document.querySelector('#typing-mode button[onclick="checkTyping()"]').classList.add('hidden');
        }

        function loadWord() {
            // ... (Existing logic for completion check and mode display)
            if (state.currentWordIndex >= state.wordQueue.length) {
                showCompletionScreen();
                return;
            }
            
            const word = state.wordQueue[state.currentWordIndex];
            
            // Hide all modes
            document.getElementById('flashcard-mode').classList.add('hidden');
            document.getElementById('quiz-mode').classList.add('hidden');
            document.getElementById('spelling-mode').classList.add('hidden');
            document.getElementById('typing-mode').classList.add('hidden'); // NEW
            
            if (state.currentExercise === 'flashcard') {
                // ... (Flashcard logic)
            } 
            else if (state.currentExercise === 'quiz') {
                // ... (Quiz logic)
            }
            else if (state.currentExercise === 'spelling') {
                // ... (Spelling logic)
            }
            else if (state.currentExercise === 'typing') { // NEW MODE
                document.getElementById('typing-mode').classList.remove('hidden');
                document.getElementById('typing-question').textContent = word.eng;
                document.getElementById('typing-input').value = '';
                document.getElementById('typing-input').disabled = false;
                document.getElementById('typing-feedback').classList.add('hidden');
                document.getElementById('typing-next-btn').classList.add('hidden');
                document.querySelector('#typing-mode button[onclick="checkTyping()"]').classList.remove('hidden');
                document.getElementById('typing-input').focus();
            }
        }
        
        // *** 5. Other updated/utility functions ***
        
        // Utility function to get current exercise mode element
        function getCurrentExerciseModeEl() {
            if (state.currentExercise === 'typing') return document.getElementById('typing-mode');
            if (state.currentExercise === 'spelling') return document.getElementById('spelling-mode');
            if (state.currentExercise === 'quiz') return document.getElementById('quiz-mode');
            if (state.currentExercise === 'flashcard') return document.getElementById('flashcard-mode');
            return null;
        }

        // Add event listener for 'Enter' key in the new typing mode
        function addTypingKeyListener() {
            document.getElementById('typing-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    if(!document.getElementById('typing-next-btn').classList.contains('hidden')) {
                         nextWord();
                    } else if (!document.querySelector('#typing-mode button[onclick="checkTyping()"]').classList.contains('hidden')) {
                         checkTyping();
                    }
                }
            });
        }
        
        // Init logic (updated to use await for loadDB)
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for DB to load from CloudStorage
            await loadDB(); 
            
            try {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                // Set TWA theme colors dynamically
                if (tg.themeParams) {
                    const style = document.documentElement.style;
                    style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
                    style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
                    style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
                    style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
                    style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
                    style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
                    style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
                    
                    tg.setHeaderColor(tg.themeParams.secondary_bg_color); 
                    tg.setBackgroundColor(tg.themeParams.bg_color);
                }
            } catch (e) {
                console.warn("Telegram WebApp script not found or failed to initialize.");
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigate(btn.dataset.view);
                });
            });

            document.getElementById('dict-search').addEventListener('input', renderDictionary);

            // Existing form listeners
            document.getElementById('add-word-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleFormSubmit();
            });
            document.getElementById('submit-bulk-btn').addEventListener('click', (e) => {
                e.preventDefault();
                handleBulkImport();
            });
            
            // Add listeners for the new 'typing' mode
            addTypingKeyListener();

            changeAddMode('single'); 
            navigate('home-view');
        });
        
        // NOTE: All other original functions (addWord, deleteWord, renderDictionary, renderStatsCharts, handleFormSubmit, etc.) 
        // are assumed to be copied and adapted where necessary, for example, to use the async saveDB/loadDB.
        
        // ... (Remaining functions like addWord, deleteWord, getWordsForExercise, updateWordMastery, logDailyActivity, shuffleArray, 
        // changeAddMode, renderHomeStats, renderDictionary, setupAddWordView, handleFormSubmit, handleBulkImport, renderStatsCharts, 
        // startLearn, flipCard, checkQuiz, checkSpelling, nextWord, showCompletionScreen from the original code would follow here) ...

        // The remaining functions from the original script should be included below, 
        // ensuring 'saveDB' and 'loadDB' calls are updated to the async versions if the calling function is also made async.
        
    </script>
</body>
</html>