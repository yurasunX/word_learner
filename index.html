<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LinguaFlow</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f5f5f5);
            --text-color: var(--tg-theme-text-color, #000);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text: var(--tg-theme-button-text-color, #fff);
            --card-bg: var(--tg-theme-secondary-bg-color, #fff);
        }
        body {
            margin: 0; padding: 20px;
            background: var(--bg-color); color: var(--text-color);
            font-family: sans-serif; height: 100vh; box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center;
        }
       .container { width: 100%; max-width: 400px; flex: 1; display: flex; flex-direction: column; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
       .card-scene { perspective: 1000px; flex: 1; display: flex; align-items: center; justify-content: center; margin: 20px 0; }
       .card {
            width: 100%; height: 300px; position: relative;
            transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer;
        }
       .card.is-flipped { transform: rotateY(180deg); }
       .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 20px;
            background: var(--card-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
       .card-back { transform: rotateY(180deg); border: 2px solid var(--button-color); }
        
        h2 { font-size: 2em; margin: 0 0 10px 0; }
        p { color: #888; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
       .controls { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
       .btn {
            flex: 1; padding: 15px; border: none; border-radius: 12px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            color: #fff; transition: opacity 0.2s;
        }
       .btn:active { opacity: 0.8; }
       .btn-hard { background: #ff4757; }
       .btn-easy { background: #2ed573; }
        
       .hidden { display: none!important; }
       .loader { font-size: 1.2em; color: var(--button-color); margin-top: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤...</div>
        
        <div id="app-content" class="hidden" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
            <div class="card-scene">
                <div class="card" id="flashcard">
                    <div class="card-face card-front">
                        <span style="font-size: 0.8em; text-transform: uppercase; opacity: 0.5;">To Translate</span>
                        <h2 id="word-target">...</h2>
                        <p>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</p>
                    </div>
                    <div class="card-face card-back">
                        <h2 id="word-native">...</h2>
                        <p id="context" style="font-style: italic; margin-top: 15px;">...</p>
                    </div>
                </div>
            </div>

            <div class="controls hidden" id="grading">
                <button class="btn btn-hard" onclick="handleGrade('hard')">–ó–∞–±—ã–ª (1 –¥–Ω)</button>
                <button class="btn btn-easy" onclick="handleGrade('easy')">–ü–æ–º–Ω—é (Next lvl)</button>
            </div>
        </div>
        
        <div id="empty-state" class="hidden" style="text-align: center; margin-top: 50px;">
            <h1>üéâ</h1>
            <h3>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë!</h3>
            <p>–í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∑–∞–≤—Ç—Ä–∞.</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞—à–∏ Webhook URL –∏–∑ n8n
        // –ï—Å–ª–∏ Production URL –≤ n8n: https://n8n.mysite.com/webhook/get-cards
        // –¢–æ BASE_URL: https://n8n.mysite.com/webhook
        const API_GET = 'https://nicola-suboptical-avelina.ngrok-free.dev/webhook-test/'; // –ù–∞–ø—Ä–∏–º–µ—Ä:.../webhook/get-cards
        const API_POST = '–í–ê–®_URL_SUBMIT_REVIEW_–ò–ó_N8N'; // –ù–∞–ø—Ä–∏–º–µ—Ä:.../webhook/submit-review

        let cards =;
        let currentIndex = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram –∏–ª–∏ —Å—Ç–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                const userId = tg.initDataUnsafe?.user?.id |

| 'TEST_USER';
                
                const response = await fetch(`${API_GET}?userId=${userId}`);
                const data = await response.json();
                
                // n8n –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                // –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –º–æ–π –∫–æ–¥ –≤—ã—à–µ, —Ç–æ Respond node –≤–µ—Ä–Ω–µ—Ç –ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤
                cards = Array.isArray(data)? data : (data.cards ||);

                document.getElementById('loader').classList.add('hidden');
                
                if (cards.length > 0) {
                    document.getElementById('app-content').classList.remove('hidden');
                    renderCard(0);
                } else {
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loader').innerText = "–û—à–∏–±–∫–∞: " + e.message;
            }
        }

        // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
        function renderCard(index) {
            if (index >= cards.length) {
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            
            const card = cards[index];
            document.getElementById('word-target').innerText = card.word_target;
            document.getElementById('word-native').innerText = card.word_native;
            document.getElementById('context').innerText = card.context |

| '';
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
            const el = document.getElementById('flashcard');
            el.classList.remove('is-flipped');
            document.getElementById('grading').classList.add('hidden');
        }

        // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç
        document.getElementById('flashcard').addEventListener('click', function() {
            this.classList.add('is-flipped');
            document.getElementById('grading').classList.remove('hidden');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        async function handleGrade(grade) {
            const card = cards[currentIndex];
            
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Å—Ä–∞–∑—É –ª–∏—Å—Ç–∞–µ–º –¥–∞–ª—å—à–µ)
            currentIndex++;
            renderCard(currentIndex);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ n8n –≤ —Ñ–æ–Ω–µ
            try {
                await fetch(API_POST, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cardId: card.card_id,
                        grade: grade,
                        currentBox: card.box
                    })
                });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", e);
            }
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>