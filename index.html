<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word Learner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #1f2937);
            -webkit-tap-highlight-color: transparent;
        }
        
        .view { display: none; animation: fadeIn 0.2s ease-in-out; }
        .view.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –æ–±—É—á–µ–Ω–∏—è */
        .flip-card { perspective: 1000px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.is-flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .flip-card-back { transform: rotateY(180deg); }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä —Å–∫—Ä—ã—Ç –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="flex flex-col h-screen pb-20">

    <header class="p-4 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md bg-white/70 border-b border-gray-200">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üéì</span>
            <h1 class="font-bold text-lg tracking-tight">WordMaster AI</h1>
        </div>
        <div class="text-xs font-medium px-2 py-1 bg-green-100 text-green-700 rounded-full" id="connection-status">
            Online
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 space-y-6">

        <div id="home-view" class="view active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">–ú–æ–∏ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</h2>
                <button onclick="openCreateSetModal()" class="text-blue-600 font-medium text-sm">+ –ù–æ–≤—ã–π –Ω–∞–±–æ—Ä</button>
            </div>

            <div id="sets-container" class="grid grid-cols-1 gap-3">
                </div>

            <div class="mt-8 bg-white p-5 rounded-2xl card-shadow border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-2">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="requestBackendAction('GPT_GENERATE_TASK')" class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1 shadow-lg shadow-purple-200">
                        <span class="text-xl">‚ú®</span>
                        <span>GPT –ó–∞–¥–∞–Ω–∏–µ</span>
                    </button>
                    <button onclick="requestBackendAction('SET_REMINDER')" class="bg-white border border-gray-200 text-gray-700 p-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1 shadow-sm">
                        <span class="text-xl">‚è∞</span>
                        <span>–ù–∞–ø–æ–º–Ω–∏—Ç—å</span>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">–î–µ–π—Å—Ç–≤–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–æ—Ç—É</p>
            </div>
        </div>

        <div id="set-view" class="view">
            <button onclick="navigate('home-view')" class="mb-4 flex items-center text-gray-500 text-sm">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞–±–æ—Ä–∞–º
            </button>
            
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h1 id="current-set-title" class="text-2xl font-bold text-gray-800">...</h1>
                    <p id="current-set-stats" class="text-sm text-gray-500">0 —Å–ª–æ–≤</p>
                </div>
                <button onclick="startLearningSession()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                    –£—á–∏—Ç—å ‚ñ∂
                </button>
            </div>

            <div id="word-list-container" class="space-y-2 pb-20">
                </div>
        </div>

        <div id="learn-view" class="view h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <button onclick="navigate('set-view')" class="text-gray-400">‚úï –í—ã—Ö–æ–¥</button>
                <div class="text-sm font-medium text-gray-500"><span id="progress-current">1</span> / <span id="progress-total">10</span></div>
            </div>

            <div class="flex-1 flex items-center justify-center">
                <div id="flashcard" class="flip-card w-full h-80" onclick="this.classList.toggle('is-flipped')">
                    <div class="flip-card-inner bg-white rounded-3xl shadow-2xl border border-gray-100">
                        <div class="flip-card-front">
                            <span class="text-xs uppercase tracking-wider text-gray-400 mb-2">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</span>
                            <h2 id="card-front" class="text-4xl font-bold text-gray-800 text-center px-4">Word</h2>
                            <p class="text-xs text-gray-400 mt-8 animate-pulse">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</p>
                        </div>
                        <div class="flip-card-back bg-gradient-to-br from-blue-50 to-white rounded-3xl">
                            <span class="text-xs uppercase tracking-wider text-blue-500 mb-2">–†—É—Å—Å–∫–∏–π</span>
                            <h2 id="card-back" class="text-3xl font-bold text-blue-700 text-center px-4">–°–ª–æ–≤–æ</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="rateWord('hard')" class="p-4 rounded-xl bg-orange-100 text-orange-700 font-semibold">–°–ª–æ–∂–Ω–æ</button>
                <button onclick="rateWord('easy')" class="p-4 rounded-xl bg-green-100 text-green-700 font-semibold">–ó–Ω–∞—é</button>
            </div>
        </div>

        <div id="add-view" class="view">
            <h2 class="text-xl font-bold mb-6">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–±–æ—Ä (–°–ª–æ–≤–∞—Ä—å)</label>
                    <select id="add-set-select" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none focus:border-blue-500 transition-colors">
                        </select>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 text-xs">ENG</span>
                        <input type="text" id="input-eng" class="w-full pt-7 pb-2 px-3 bg-white border border-gray-200 rounded-xl outline-none focus:border-blue-500 text-lg font-medium" placeholder="Apple">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 text-xs">RUS</span>
                        <input type="text" id="input-rus" class="w-full pt-7 pb-2 px-3 bg-white border border-gray-200 rounded-xl outline-none focus:border-blue-500 text-lg font-medium" placeholder="–Ø–±–ª–æ–∫–æ">
                    </div>
                </div>
                
                <div class="pt-4">
                    <button onclick="saveNewWord()" class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–æ–≤–æ
                    </button>
                    
                    <div class="mt-6">
                        <p class="text-sm text-gray-500 mb-2">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–∫–æ–º:</p>
                        <textarea id="bulk-input" class="w-full p-3 border border-gray-200 rounded-xl text-sm h-24" placeholder="Dog - –°–æ–±–∞–∫–∞&#10;Cat - –ö–æ—à–∫–∞"></textarea>
                        <button onclick="saveBulkWords()" class="mt-2 w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-medium">–ò–º–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around pb-safe pt-2 px-2 z-50 h-16">
        <button onclick="navigate('home-view')" class="nav-btn flex-1 flex flex-col items-center justify-center text-blue-600" data-target="home-view">
            <span class="text-2xl">üè†</span>
            <span class="text-[10px] font-medium mt-1">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button onclick="navigate('add-view')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400" data-target="add-view">
            <div class="bg-blue-600 rounded-full p-2 -mt-6 shadow-lg border-4 border-white">
                <span class="text-white text-xl font-bold">+</span>
            </div>
        </button>
        <button onclick="navigate('learn-view')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400" data-target="learn-view">
             <span class="text-2xl">üìä</span>
             <span class="text-[10px] font-medium mt-1">–°—Ç–∞—Ç—É—Å</span>
        </button>
    </nav>

    <div id="modal-create-set" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-bounce-in">
            <h3 class="text-lg font-bold mb-4">–ù–æ–≤—ã–π –Ω–∞–±–æ—Ä —Å–ª–æ–≤</h3>
            <input type="text" id="new-set-name" class="w-full p-3 border border-gray-200 rounded-xl mb-4 focus:ring-2 ring-blue-500 outline-none" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–ª–∞–≥–æ–ª—ã">
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-create-set').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-medium">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="createNewSet()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // === 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ë–ê–ó–ê –î–ê–ù–ù–´–• (CloudStorage) ===
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å)
        // db.sets = [{ id: 1, name: "–§—Ä—É–∫—Ç—ã", color: "bg-red-100" }]
        // db.words = [{ id: 101, setId: 1, eng: "Apple", rus: "–Ø–±–ª–æ–∫–æ", level: 0 }]
        let db = {
            sets: [],
            words: []
        };

        const STORAGE_KEY = 'word_learner_v3_db';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–°–∏–º—É–ª—è—Ü–∏—è DB)
        async function initApp() {
            try {
                if(tg.CloudStorage) {
                    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞ Telegram
                    const raw = await new Promise((resolve) => {
                        tg.CloudStorage.getItem(STORAGE_KEY, (err, val) => resolve(val));
                    });
                    if(raw) db = JSON.parse(raw);
                } else {
                    // LocalStorage –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if(raw) db = JSON.parse(raw);
                }
            } catch(e) { console.error(e); }

            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–∞–±–æ—Ä
            if(db.sets.length === 0) {
                db.sets.push({ id: Date.now(), name: '–ú–æ–π –ø–µ—Ä–≤—ã–π —Å–ª–æ–≤–∞—Ä—å', color: 'bg-blue-100' });
                saveDB();
            }

            renderSets();
            updateSetSelect();
        }

        function saveDB() {
            const data = JSON.stringify(db);
            if(tg.CloudStorage) {
                tg.CloudStorage.setItem(STORAGE_KEY, data);
            } else {
                localStorage.setItem(STORAGE_KEY, data);
            }
        }

        // === 2. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
        
        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewId) btn.classList.add('text-blue-600', 'text-gray-400');
                else btn.classList.remove('text-blue-600');
                if(btn.dataset.target !== viewId) btn.classList.add('text-gray-400');
            });

            if(viewId === 'home-view') renderSets();
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ù–∞–±–æ—Ä–∞–º–∏ (Sets) ---

        function renderSets() {
            const container = document.getElementById('sets-container');
            container.innerHTML = '';

            db.sets.forEach(set => {
                const wordCount = db.words.filter(w => w.setId === set.id).length;
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-2xl border border-gray-100 card-shadow flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer';
                div.onclick = () => openSet(set.id);
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl ${set.color || 'bg-gray-100'} flex items-center justify-center text-xl">
                            üìÅ
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">${set.name}</h3>
                            <p class="text-xs text-gray-500">${wordCount} —Å–ª–æ–≤ ‚Ä¢ –ò–∑—É—á–∞–µ—Ç—Å—è</p>
                        </div>
                    </div>
                    <div class="text-gray-300">‚ûú</div>
                `;
                container.appendChild(div);
            });
        }

        function openCreateSetModal() {
            document.getElementById('modal-create-set').classList.remove('hidden');
            document.getElementById('new-set-name').focus();
        }

        function createNewSet() {
            const name = document.getElementById('new-set-name').value.trim();
            if(!name) return;

            const colors = ['bg-red-100', 'bg-blue-100', 'bg-green-100', 'bg-purple-100', 'bg-orange-100'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];

            db.sets.push({
                id: Date.now(),
                name: name,
                color: randomColor
            });
            saveDB();
            document.getElementById('new-set-name').value = '';
            document.getElementById('modal-create-set').classList.add('hidden');
            renderSets();
            updateSetSelect();
        }

        // --- –ü—Ä–æ—Å–º–æ—Ç—Ä –ù–∞–±–æ—Ä–∞ –∏ –°–ª–æ–≤ ---

        let currentSetId = null;

        function openSet(setId) {
            currentSetId = setId;
            const set = db.sets.find(s => s.id === setId);
            const words = db.words.filter(w => w.setId === setId);
            
            document.getElementById('current-set-title').innerText = set.name;
            document.getElementById('current-set-stats').innerText = `${words.length} —Å–ª–æ–≤ –≤—Å–µ–≥–æ`;
            
            const list = document.getElementById('word-list-container');
            list.innerHTML = '';

            if(words.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400">–í —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ.<br>–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞!</div>`;
            }

            words.forEach(word => {
                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center mb-2';
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${word.eng}</div>
                        <div class="text-sm text-gray-500">${word.rus}</div>
                    </div>
                    <div class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">lvl ${word.level || 0}</div>
                `;
                list.appendChild(item);
            });

            navigate('set-view');
        }

        // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –°–ª–æ–≤ ---

        function updateSetSelect() {
            const sel = document.getElementById('add-set-select');
            sel.innerHTML = '';
            db.sets.forEach(set => {
                const opt = document.createElement('option');
                opt.value = set.id;
                opt.innerText = set.name;
                sel.appendChild(opt);
            });
        }

        function saveNewWord() {
            const setId = Number(document.getElementById('add-set-select').value);
            const eng = document.getElementById('input-eng').value.trim();
            const rus = document.getElementById('input-rus').value.trim();

            if(!eng || !rus) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            db.words.push({
                id: Date.now(),
                setId: setId,
                eng: eng,
                rus: rus,
                level: 0, // 0 - –Ω–æ–≤–æ–µ, 5 - –≤—ã—É—á–µ–Ω–æ
                nextReview: Date.now()
            });

            saveDB();
            tg.HapticFeedback.notificationOccurred('success');
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('input-eng').value = '';
            document.getElementById('input-rus').value = '';
            document.getElementById('input-eng').focus();
        }
        
        function saveBulkWords() {
            const setId = Number(document.getElementById('add-set-select').value);
            const text = document.getElementById('bulk-input').value.trim();
            if(!text) return;
            
            const lines = text.split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.split(/[-‚Äì‚Äî:]/); // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                if(parts.length >= 2) {
                    db.words.push({
                        id: Date.now() + Math.random(),
                        setId: setId,
                        eng: parts[0].trim(),
                        rus: parts[1].trim(),
                        level: 0,
                        nextReview: Date.now()
                    });
                    count++;
                }
            });
            
            saveDB();
            tg.HapticFeedback.notificationOccurred('success');
            alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ —Å–ª–æ–≤: ${count}`);
            document.getElementById('bulk-input').value = '';
        }

        // === 3. –û–ë–£–ß–ï–ù–ò–ï (–ö–∞—Ä—Ç–æ—á–∫–∏) ===
        
        let learningQueue = [];
        let currentCardIdx = 0;

        function startLearningSession() {
            if(!currentSetId) return;
            // –ê–ª–≥–æ—Ä–∏—Ç–º: –±–µ—Ä–µ–º —Å–ª–æ–≤–∞ —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—é (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
            const words = db.words.filter(w => w.setId === currentSetId);
            if(words.length === 0) {
                alert("–°–ª–æ–≤–∞—Ä—å –ø—É—Å—Ç");
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            learningQueue = words.sort(() => 0.5 - Math.random()).slice(0, 10); // –ë–µ—Ä–µ–º 10 —Å–ª—É—á–∞–π–Ω—ã—Ö
            currentCardIdx = 0;
            
            document.getElementById('progress-total').innerText = learningQueue.length;
            showCard();
            navigate('learn-view');
        }

        function showCard() {
            if(currentCardIdx >= learningQueue.length) {
                // –ö–æ–Ω–µ—Ü —Å–µ—Å—Å–∏–∏
                alert("–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.");
                navigate('set-view');
                return;
            }
            
            const word = learningQueue[currentCardIdx];
            document.getElementById('card-front').innerText = word.eng;
            document.getElementById('card-back').innerText = word.rus;
            document.getElementById('progress-current').innerText = currentCardIdx + 1;
            
            // –°–±—Ä–æ—Å –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
            document.getElementById('flashcard').classList.remove('is-flipped');
        }

        function rateWord(rating) {
            const word = learningQueue[currentCardIdx];
            
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
            const dbWord = db.words.find(w => w.id === word.id);
            if(dbWord) {
                if(rating === 'easy') dbWord.level = Math.min(dbWord.level + 1, 5);
                else dbWord.level = Math.max(dbWord.level - 1, 0);
                saveDB();
            }

            currentCardIdx++;
            showCard();
        }

        // === 4. BACKEND –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (GPT & –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø) ===

        function requestBackendAction(actionType) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã
            if (!tg.initData) {
                alert("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram!");
                return;
            }

            let payload = { action: actionType };

            if (actionType === 'GPT_GENERATE_TASK') {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–ª–æ–≤ –±–æ—Ç—É, —á—Ç–æ–±—ã –æ–Ω —Å–æ—Å—Ç–∞–≤–∏–ª –ø–æ –Ω–∏–º quiz
                const recentWords = db.words.slice(-20).map(w => `${w.eng} - ${w.rus}`);
                payload.data = { words: recentWords };
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
                tg.MainButton.setText("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —É AI...");
                tg.MainButton.show();
                tg.MainButton.showProgress();
            } else if (actionType === 'SET_REMINDER') {
                 payload.data = { time: '19:00' }; // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É. 
            // –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ª–æ–≤–∏—Ç—å —ç—Ç–æ –≤ 'web_app_data' update
            tg.sendData(JSON.stringify(payload));
        }

        // –ó–∞–ø—É—Å–∫
        initApp();

    </script>
</body>
</html>