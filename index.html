<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Word Learner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #1f2937);
            -webkit-tap-highlight-color: transparent;
        }
        
        .view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view.active { display: flex; flex-direction: column; height: 100%; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .flip-card-inner {
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="px-4 py-3 bg-white shadow-sm flex justify-between items-center z-10">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-brain text-indigo-600 text-xl"></i>
            <h1 class="font-bold text-lg text-gray-800">NeuroLearn</h1>
        </div>
        <div class="text-xs font-semibold px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg">
            <span id="due-count">0</span> –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é
        </div>
    </header>

    <main class="flex-1 overflow-y-auto relative bg-gray-50">

        <div id="home-view" class="view active p-4 space-y-6">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200">
                <h2 class="text-2xl font-bold mb-1">–ü—Ä–∏–≤–µ—Ç! üëã</h2>
                <p class="text-indigo-100 text-sm mb-4">–¢–≤–æ–π AI-–∞–≥–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.</p>
                <div class="flex gap-3">
                    <button onclick="startSession('due')" class="flex-1 bg-white text-indigo-600 py-2 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-transform">
                        üöÄ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (<span class="due-counter">0</span>)
                    </button>
                    <button onclick="navigate('import-view')" class="flex-1 bg-indigo-500 bg-opacity-30 border border-indigo-400 text-white py-2 rounded-xl font-bold text-sm backdrop-blur-sm active:scale-95 transition-transform">
                        üì• AI –ò–º–ø–æ—Ä—Ç
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-400 text-xs mb-1">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
                    <div class="text-2xl font-bold text-gray-800" id="stat-total">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-400 text-xs mb-1">–í—ã—É—á–µ–Ω–æ (Mastered)</div>
                    <div class="text-2xl font-bold text-green-600" id="stat-mastered">0</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-100 font-semibold text-gray-700">–†–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è</div>
                <button onclick="startSession('new')" class="w-full text-left p-4 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-plus"></i></div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">–£—á–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</div>
                        <div class="text-xs text-gray-500">5 —Å–ª–æ–≤ ‚Ä¢ –ö–∞—Ä—Ç–æ—á–∫–∏</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </button>
                <button onclick="startSession('write')" class="w-full text-left p-4 hover:bg-gray-50 flex items-center gap-3 transition-colors border-t border-gray-100">
                    <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-pen"></i></div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">–ü–∏—Å—å–º–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</div>
                        <div class="text-xs text-gray-500">–•–∞—Ä–¥–∫–æ—Ä —Ä–µ–∂–∏–º</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </button>
            </div>
        </div>

        <div id="import-view" class="view p-4 h-full">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="navigate('home-view')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                <h2 class="text-xl font-bold">AI –ò–º–ø–æ—Ä—Ç</h2>
            </div>
            
            <div class="flex-1 flex flex-col space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <div class="flex gap-2 items-start">
                        <i class="fa-solid fa-robot text-blue-500 mt-1"></i>
                        <p class="text-sm text-blue-800">
                            –í—Å—Ç–∞–≤—å—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç, —Å—Ç–∞—Ç—å—é, —Å—É–±—Ç–∏—Ç—Ä—ã –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤. <br>
                            <b>AI –ê–≥–µ–Ω—Ç (n8n)</b> —Å–∞–º –Ω–∞–π–¥–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –∏—Ö –∏ —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–∏–º–µ—Ä—ã.
                        </p>
                    </div>
                </div>

                <textarea id="ai-import-text" class="flex-1 w-full p-4 rounded-xl border-2 border-gray-200 focus:border-indigo-500 outline-none resize-none text-base" placeholder="Paste English text here..."></textarea>
                
                <button onclick="sendToAI()" class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ê–≥–µ–Ω—Ç—É
                </button>
            </div>
        </div>

        <div id="study-view" class="view p-4 h-full relative">
            <div class="flex justify-between items-center mb-4">
                <button onclick="exitStudy()" class="text-gray-400"><i class="fa-solid fa-times text-xl"></i></button>
                <div class="h-2 w-32 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
                </div>
                <span id="study-counter" class="text-sm font-medium text-gray-500">1/10</span>
            </div>

            <div class="flex-1 flex items-center justify-center perspective-1000 mb-20">
                <div id="flashcard" class="relative w-full h-[400px] transform-style-3d cursor-pointer transition-all duration-500" onclick="flipCard()">
                    
                    <div class="flip-card-front absolute w-full h-full bg-white rounded-3xl shadow-xl border border-gray-100 p-6 flex flex-col items-center justify-center backface-hidden z-20">
                        <span class="text-xs uppercase tracking-widest text-gray-400 mb-4">English</span>
                        <h2 id="card-eng" class="text-4xl font-bold text-gray-800 text-center mb-6">Word</h2>
                        
                        <div id="card-context" class="bg-gray-50 px-4 py-2 rounded-lg text-sm text-gray-500 italic text-center max-w-[90%] hidden">
                            "Example sentence..."
                        </div>
                        
                        <p class="absolute bottom-6 text-gray-300 text-xs animate-pulse">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</p>
                    </div>

                    <div class="flip-card-back absolute w-full h-full bg-gradient-to-br from-indigo-50 to-white rounded-3xl shadow-xl border border-indigo-100 p-6 flex flex-col items-center justify-center backface-hidden rotate-y-180 z-10">
                        <span class="text-xs uppercase tracking-widest text-indigo-400 mb-4">Russian</span>
                        <h2 id="card-rus" class="text-3xl font-bold text-indigo-700 text-center">–ü–µ—Ä–µ–≤–æ–¥</h2>
                        <div class="mt-8 w-full border-t border-indigo-100 pt-4">
                            <p class="text-xs text-center text-gray-400 mb-2">–ú–µ—Ç–æ–¥–∏–∫–∞: –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</p>
                            <div class="flex justify-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-red-400"></span>
                                <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="srs-controls" class="fixed bottom-6 left-4 right-4 grid grid-cols-3 gap-3 hidden">
                <button onclick="processResult('hard')" class="bg-red-100 text-red-700 py-4 rounded-xl font-bold shadow-sm active:scale-95">
                    –ó–∞–±—ã–ª
                    <div class="text-[10px] font-normal opacity-70">–°–±—Ä–æ—Å</div>
                </button>
                <button onclick="processResult('good')" class="bg-yellow-100 text-yellow-700 py-4 rounded-xl font-bold shadow-sm active:scale-95">
                    –ù–æ—Ä–º
                    <div class="text-[10px] font-normal opacity-70">3 –¥–Ω—è</div>
                </button>
                <button onclick="processResult('easy')" class="bg-green-100 text-green-700 py-4 rounded-xl font-bold shadow-sm active:scale-95">
                    –õ–µ–≥–∫–æ
                    <div class="text-[10px] font-normal opacity-70">7 –¥–Ω–µ–π</div>
                </button>
            </div>
        </div>

    </main>

    <script>
        // === 1. DATA & CONFIG ===
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –ò–º–∏—Ç–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ CloudStorage
        let db = {
            // –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–ª–æ–≤–∞
            words: [
                { id: 1, eng: 'Epiphany', rus: '–ü—Ä–æ–∑—Ä–µ–Ω–∏–µ', context: 'I had an epiphany about code.', nextReview: 0, interval: 0 },
                { id: 2, eng: 'Serendipity', rus: '–°—á–∞—Å—Ç–ª–∏–≤–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å', context: null, nextReview: 0, interval: 0 },
                { id: 3, eng: 'Obsolete', rus: '–£—Å—Ç–∞—Ä–µ–≤—à–∏–π', context: 'This technology is obsolete.', nextReview: Date.now() + 86400000, interval: 1 }
            ]
        };

        // State
        let sessionQueue = [];
        let currentWordIndex = 0;
        let isFlipped = false;

        // === 2. CORE LOGIC: AI AGENT INTEGRATION ===

        function sendToAI() {
            const text = document.getElementById('ai-import-text').value.trim();
            if (!text) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è N8N (—á–µ—Ä–µ–∑ –±–æ—Ç–∞)
            const payload = {
                action: 'AI_SMART_PARSE',
                rawData: text,
                timestamp: Date.now()
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞—Ç—å –∏—Ö –≤ n8n Webhook.
            // n8n —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç, –≤—ã–¥–µ–ª–∏—Ç —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤ –ë–î.
            tg.sendData(JSON.stringify(payload));
            tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º TWA –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        }

        // === 3. CORE LOGIC: SPACED REPETITION (SRS) ===
        
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º (–ø–æ—Ö–æ–∂ –Ω–∞ Leitner / SM-2 simplified)
        function calculateNextReview(currentInterval, rating) {
            // rating: 'hard' (fail), 'good', 'easy'
            const DAY_MS = 86400000;

            if (rating === 'hard') {
                return { interval: 0, nextDate: Date.now() }; // –°–±—Ä–æ—Å, —É—á–∏–º —Å–µ–π—á–∞—Å/–∑–∞–≤—Ç—Ä–∞
            }

            let newInterval;
            if (rating === 'good') {
                // –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –±—ã–ª 0, —Å—Ç–∞–≤–∏–º 1 –¥–µ–Ω—å, –∏–Ω–∞—á–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 1.5 —Ä–∞–∑–∞
                newInterval = currentInterval === 0 ? 1 : Math.ceil(currentInterval * 1.5);
            } else if (rating === 'easy') {
                // –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –±—ã–ª 0, —Å—Ç–∞–≤–∏–º 3 –¥–Ω—è, –∏–Ω–∞—á–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 2.5 —Ä–∞–∑–∞
                newInterval = currentInterval === 0 ? 3 : Math.ceil(currentInterval * 2.5);
            }

            return {
                interval: newInterval,
                nextDate: Date.now() + (newInterval * DAY_MS)
            };
        }

        // === 4. UI FUNCTIONS ===

        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'home-view') updateStats();
        }

        function updateStats() {
            const now = Date.now();
            const dueWords = db.words.filter(w => w.nextReview <= now).length;
            const mastered = db.words.filter(w => w.interval > 20).length; // –°—á–∏—Ç–∞–µ–º –≤—ã—É—á–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª > 20 –¥–Ω–µ–π
            
            document.getElementById('due-count').innerText = dueWords;
            document.querySelectorAll('.due-counter').forEach(el => el.innerText = dueWords);
            document.getElementById('stat-total').innerText = db.words.length;
            document.getElementById('stat-mastered').innerText = mastered;
        }

        // --- Study Session Logic ---

        function startSession(mode) {
            const now = Date.now();
            
            if (mode === 'due') {
                // –£—á–∏–º —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–æ—à–ª–æ –≤—Ä–µ–º—è
                sessionQueue = db.words.filter(w => w.nextReview <= now);
            } else if (mode === 'new') {
                // –£—á–∏–º —Å–ª–æ–≤–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 0 (–Ω–æ–≤—ã–µ –∏–ª–∏ —Å–±—Ä–æ—à–µ–Ω–Ω—ã–µ)
                sessionQueue = db.words.filter(w => w.interval === 0).slice(0, 5);
            } else {
                // Fallback
                sessionQueue = [...db.words];
            }

            if (sessionQueue.length === 0) {
                alert("–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! –û—Ç–¥–æ—Ö–Ω–∏ üéâ");
                return;
            }

            // –ü–µ—Ä–µ–º–µ—à–∞—Ç—å
            sessionQueue.sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            
            updateProgressBar();
            loadCard();
            navigate('study-view');
        }

        function loadCard() {
            isFlipped = false;
            const word = sessionQueue[currentWordIndex];
            const card = document.getElementById('flashcard');
            const ctrls = document.getElementById('srs-controls');
            
            // Reset UI
            card.classList.remove('flipped');
            ctrls.classList.add('hidden'); // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É–ª

            // Fill content
            document.getElementById('card-eng').innerText = word.eng;
            document.getElementById('card-rus').innerText = word.rus;
            
            // Context Logic
            const ctxEl = document.getElementById('card-context');
            if (word.context) {
                ctxEl.innerText = `"${word.context}"`;
                ctxEl.classList.remove('hidden');
            } else {
                ctxEl.classList.add('hidden');
            }

            document.getElementById('study-counter').innerText = `${currentWordIndex + 1}/${sessionQueue.length}`;
        }

        function flipCard() {
            if (isFlipped) return; // –£–∂–µ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞
            
            const card = document.getElementById('flashcard');
            card.classList.add('flipped');
            isFlipped = true;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã SRS
            setTimeout(() => {
                document.getElementById('srs-controls').classList.remove('hidden');
                document.getElementById('srs-controls').classList.add('grid');
            }, 300);
        }

        function processResult(rating) {
            const word = sessionQueue[currentWordIndex];
            
            // 1. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            const result = calculateNextReview(word.interval || 0, rating);
            
            // 2. –û–±–Ω–æ–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –ë–î
            const dbWordIndex = db.words.findIndex(w => w.id === word.id);
            if (dbWordIndex !== -1) {
                db.words[dbWordIndex].nextReview = result.nextDate;
                db.words[dbWordIndex].interval = result.interval;
                // –¢—É—Ç –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å saveDB() –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ CloudStorage
            }

            // 3. –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
            tg.HapticFeedback.notificationOccurred(rating === 'hard' ? 'error' : 'success');

            // 4. –°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
            currentWordIndex++;
            updateProgressBar();

            if (currentWordIndex >= sessionQueue.length) {
                finishSession();
            } else {
                loadCard();
            }
        }

        function updateProgressBar() {
            const percent = ((currentWordIndex) / sessionQueue.length) * 100;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        function finishSession() {
            alert("–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–ª–æ–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
            navigate('home-view');
        }

        function exitStudy() {
            if(confirm("–ó–∞–∫–æ–Ω—á–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É? –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.")) {
                navigate('home-view');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–∏–º–∏—Ç–∞—Ü–∏—è)
            // loadDB()... 
            updateStats();
        });

    </script>
</body>
</html>