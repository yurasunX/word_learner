<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LinguaFlow SRS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f0f2f5);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Loader */
       .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            font-size: 1.1em;
            color: var(--hint-color);
        }

        /* Flashcard Scene */
       .scene {
            flex: 1;
            perspective: 1000px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

       .card {
            width: 100%;
            height: 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
            max-height: 60vh;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            cursor: pointer;
        }

       .card.is-flipped {
            transform: rotateY(180deg);
        }

       .card__face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            background-color: var(--card-bg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.05);
        }

       .card__face--back {
            transform: rotateY(180deg);
            background-color: #fff8e1; /* –õ–µ–≥–∫–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã */
            color: #333;
        }

        /* Typography */
       .word-target {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 10px;
        }

       .word-native {
            font-size: 2em;
            font-weight: 600;
            color: #444;
            margin-bottom: 20px;
        }

       .context {
            font-style: italic;
            color: #666;
            line-height: 1.5;
        }

       .hint {
            position: absolute;
            bottom: 20px;
            font-size: 0.85em;
            color: var(--hint-color);
            opacity: 0.7;
        }

        /* Controls */
       .controls {
            display: flex;
            gap: 12px;
            height: 56px;
        }

       .btn {
            flex: 1;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            color: white;
        }

       .btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

       .btn-hard { background-color: #ff4757; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3); }
       .btn-good { background-color: #2ed573; box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3); }

       .hidden { display: none!important; }
        
        /* Empty State */
       .empty-state {
            text-align: center;
            margin-top: 100px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="loader" class="loader-container">
            <div>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è...</div>
        </div>

        <div id="game" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <div class="scene">
                <div class="card" id="flashcard">
                    <div class="card__face card__face--front">
                        <div class="word-target" id="card-front-text">Loading...</div>
                        <div class="hint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</div>
                    </div>
                    <div class="card__face card__face--back">
                        <div class="word-native" id="card-back-trans">...</div>
                        <div class="context" id="card-back-context">...</div>
                    </div>
                </div>
            </div>

            <div class="controls hidden" id="controls">
                <button class="btn btn-hard" onclick="handleGrade('hard')">–ó–∞–±—ã–ª (1 –¥–Ω)</button>
                <button class="btn btn-good" onclick="handleGrade('good')">–ü–æ–º–Ω—é (Dal'she)</button>
            </div>
        </div>

        <div id="done" class="empty-state hidden">
            <div style="font-size: 4em;">üéâ</div>
            <h2>–í—Å–µ —Å–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤—ã—É—á–µ–Ω—ã!</h2>
            <p style="color: var(--hint-color);">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ==========================================
        // –ù–ê–°–¢–†–û–ô–ö–ò (–í–°–¢–ê–í–¨–¢–ï –°–í–û–ô URL –ù–ò–ñ–ï)
        // URL –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫: https://.../webhook
        // –ë–ï–ó "/get-cards" –Ω–∞ –∫–æ–Ω—Ü–µ.
        // ==========================================
        const BASE_WEBHOOK_URL = "https://nicola-suboptical-avelina.ngrok-free.dev/webhook-test/get-cards"; 
        
        let deck =;
        let currentIndex = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initApp() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram (–∏–ª–∏ —Å—Ç–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
                const userId = tg.initDataUnsafe?.user?.id |

| 'TEST_USER_1';
                
                // –ó–∞–ø—Ä–æ—Å –∫ n8n
                const response = await fetch(`${BASE_WEBHOOK_URL}/get-cards?userId=${userId}`);
                
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                
                const data = await response.json();
                // n8n –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å { cards: [...] } –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ [...]
                deck = data.cards |

| data ||;

                document.getElementById('loader').classList.add('hidden');

                if (deck.length > 0) {
                    document.getElementById('game').classList.remove('hidden');
                    renderCard(0);
                } else {
                    document.getElementById('done').classList.remove('hidden');
                }

            } catch (e) {
                document.getElementById('loader').innerText = "–û—à–∏–±–∫–∞: " + e.message;
                console.error(e);
            }
        }

        function renderCard(index) {
            if (index >= deck.length) {
                document.getElementById('game').classList.add('hidden');
                document.getElementById('done').classList.remove('hidden');
                tg.HapticFeedback.notificationOccurred('success');
                return;
            }

            const cardData = deck[index];
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('card-front-text').innerText = cardData.word_target;
            document.getElementById('card-back-trans').innerText = cardData.word_native;
            document.getElementById('card-back-context').innerText = cardData.context |

| "";

            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –æ–±—Ä–∞—Ç–Ω–æ)
            const cardEl = document.getElementById('flashcard');
            cardEl.classList.remove('is-flipped');
            document.getElementById('controls').classList.add('hidden');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        document.getElementById('flashcard').addEventListener('click', function() {
            this.classList.toggle('is-flipped');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞ (—Ä—É–±–∞—à–∫–æ–π –≤–≤–µ—Ä—Ö)
            if (this.classList.contains('is-flipped')) {
                document.getElementById('controls').classList.remove('hidden');
            } else {
                document.getElementById('controls').classList.add('hidden');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–ó–Ω–∞—é / –ù–µ –∑–Ω–∞—é)
        async function handleGrade(grade) {
            const currentCard = deck[currentIndex];
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ n8n (–Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ã–ª –±—ã—Å—Ç—Ä—ã–º)
            fetch(`${BASE_WEBHOOK_URL}/submit-review`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cardId: currentCard.card_id,
                    grade: grade,
                    currentBox: currentCard.box
                })
            }).catch(err => console.error("Sync error:", err));

            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π
            currentIndex++;
            renderCard(currentIndex);
        }

        // –ó–∞–ø—É—Å–∫
        initApp();
    </script>
</body>
</html>