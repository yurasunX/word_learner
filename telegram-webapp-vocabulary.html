<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WordFlash — Telegram Web App</title>
<style>
  :root{
    --bg:#f6f8fa; --card:#fff; --accent:#0077b6; --muted:#666;
  }
  body{margin:0;font-family:Inter, Roboto, Arial; background:var(--bg); color:#111;}
  header{padding:12px 16px; display:flex; align-items:center; gap:12px; background:linear-gradient(90deg,#ffffff00, #ffffff00);}
  .app{max-width:900px;margin:18px auto;padding:12px;}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(13,38,59,0.06);margin-bottom:14px;}
  h1{font-size:18px;margin:0 0 8px 0;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;}
  .btn.secondary{background:#e6eef8;color:#0366a6;font-weight:600;border:1px solid #bcdff6;}
  #word{font-size:28px;margin:12px 0;}
  input[type=text], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e3e7eb;font-size:15px;}
  .small{font-size:13px;color:var(--muted);}
  .row{display:flex;gap:8px;align-items:center;}
  .inline{display:inline-block;}
  .kbd{background:#f1f5f8;border-radius:6px;padding:6px 8px;font-size:13px;border:1px solid #e3e7eb;}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px;}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header>
  <div style="flex:1">
    <strong>WordFlash</strong>
    <div class="small">Карточки • Квизы • Загрузка списков</div>
  </div>
  <div class="kbd">v1.0</div>
</header>

<main class="app">
  <div class="card" id="ui-main">
    <h1 id="title">Карточки</h1>

    <div id="card-view">
      <div id="word" aria-live="polite">Загрузка...</div>
      <div class="small">Перевод — введите ответ ↓</div>
      <input id="answer" type="text" placeholder="Введите перевод" autocomplete="off"/>
      <div style="height:10px"></div>
      <div class="controls">
        <button class="btn" id="checkBtn">Проверить</button>
        <button class="btn secondary" id="showBtn">Показать перевод</button>
        <button class="btn secondary" id="nextBtn">Следующая</button>
        <button class="btn secondary" id="toQuizBtn">Квиз</button>
      </div>
      <div style="height:8px"></div>
      <div id="feedback" class="small"></div>
    </div>

    <div id="upload-section" style="display:none;">
      <h1>Загрузить список</h1>
      <div class="small">Поддерживается: plain text (слово - перевод в строке), CSV, просто слова через запятую</div>
      <textarea id="listText" rows="8" placeholder="Например: hello - привет&#10;world - мир"></textarea>
      <div style="height:8px"></div>
      <div class="controls">
        <button class="btn" id="uploadBtn">Отправить список</button>
        <button class="btn secondary" id="parseSampleBtn">Авто-парсер (AI)</button>
      </div>
      <div id="uploadFeedback" class="small"></div>
    </div>

    <div id="quiz-section" style="display:none;">
      <h1>Квиз</h1>
      <div id="quizQuestion" style="font-size:20px;margin-bottom:8px">Вопрос...</div>
      <div id="options"></div>
      <div style="height:8px"></div>
      <div class="controls">
        <button class="btn secondary" id="quitQuiz">Выйти</button>
      </div>
      <div id="quizFeedback" class="small"></div>
    </div>

    <div style="height:10px"></div>
    <div class="controls">
      <button class="btn secondary" id="showUpload">Загрузить свой список</button>
      <button class="btn secondary" id="settingsBtn">Настройки уведомлений</button>
      <button class="btn secondary" id="clearBtn">Очистить</button>
    </div>
  </div>

  <footer>Данные сохраняются в Google Sheets. Управление уведомлениями — через бота.</footer>
</main>

<script>
/*
  Настройки:
  - N8N_WEBHOOK_BASE: ваш публичный webhook в n8n, который принимает действия WebApp.
    Пример: https://your-n8n.example.com/webhook/wordflash
*/
const N8N_WEBHOOK_BASE = "REPLACE_WITH_YOUR_N8N_WEBHOOK_URL"; // <-- Замените
const SHEET_ID = "REPLACE_WITH_GOOGLE_SHEET_ID"; // опционально - для фронтенда не обязательно

// Инициализация Telegram WebApp
const tg = window.Telegram.WebApp;
tg.expand(); // расширить под доступное пространство
tg.ready();

// из initData получаем user (безопасно)
const user = tg.initDataUnsafe?.user || { id: null, first_name: null };

let currentWord = null;
let currentTranslation = null;
let quizMode = false;

const el = id => document.getElementById(id);
const setWordUI = (w) => { el('word').innerText = w || '—'; el('answer').value=''; el('feedback').innerText=''; };

async function apiPost(action, payload = {}) {
  // Добавляем инфу о пользователе
  const body = { action, user, payload };
  try {
    const res = await fetch(N8N_WEBHOOK_BASE, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch(err) {
    console.error('apiPost error', err);
    return { ok:false, error: String(err) };
  }
}

// Загрузка первого слова при старте
async function loadNext() {
  const r = await apiPost('nextCard');
  if (!r.ok) { setWordUI('Ошибка загрузки'); el('feedback').innerText = r.error; return; }
  currentWord = r.word;
  currentTranslation = r.translation;
  setWordUI(currentWord);
}
async function checkAnswer() {
  const ans = el('answer').value.trim();
  const r = await apiPost('checkAnswer', { word: currentWord, answer: ans });
  if (r.ok) {
    el('feedback').innerText = r.correct ? 'Верно ✅' : `Неверно — ${currentTranslation} ❌`;
  } else el('feedback').innerText = 'Ошибка: ' + r.error;
}
async function showTranslation() {
  el('feedback').innerText = currentTranslation ? `Перевод: ${currentTranslation}` : 'Перевод неизвестен';
}
async function uploadList() {
  const text = el('listText').value.trim();
  if (!text) { el('uploadFeedback').innerText = 'Пустой список'; return; }
  el('uploadFeedback').innerText = 'Отправка...';
  const r = await apiPost('uploadList', { raw: text });
  if (r.ok) el('uploadFeedback').innerText = `Добавлено: ${r.added} слов`;
  else el('uploadFeedback').innerText = 'Ошибка: ' + r.error;
}
async function aiParseAndUpload() {
  const text = el('listText').value.trim();
  if (!text) { el('uploadFeedback').innerText = 'Пустой список'; return; }
  el('uploadFeedback').innerText = 'Парсинг (AI)...';
  const r = await apiPost('aiParseUpload', { raw: text });
  if (r.ok) el('uploadFeedback').innerText = `AI: добавлено ${r.added} слов`;
  else el('uploadFeedback').innerText = 'Ошибка: ' + r.error;
}

// Quiz: получаем вопрос и варианты
async function startQuiz() {
  quizMode = true;
  document.getElementById('card-view').style.display='none';
  document.getElementById('upload-section').style.display='none';
  document.getElementById('quiz-section').style.display='block';
  const r = await apiPost('quizQuestion');
  if (!r.ok) { el('quizQuestion').innerText='Ошибка'; el('quizFeedback').innerText=r.error; return; }
  el('quizQuestion').innerText = r.question;
  el('options').innerHTML = '';
  r.options.forEach(opt=>{
    const b = document.createElement('button');
    b.className='btn secondary';
    b.style.display='block';
    b.style.width='100%';
    b.style.margin='6px 0';
    b.innerText = opt;
    b.onclick = async () => {
      const res = await apiPost('checkQuiz', { questionId: r.id, selected: opt });
      el('quizFeedback').innerText = res.ok ? (res.correct ? 'Правильно ✅' : `Неправильно — ${res.correctAnswer}`) : 'Ошибка';
    };
    el('options').appendChild(b);
  });
}

function stopQuiz() {
  quizMode = false;
  document.getElementById('card-view').style.display='block';
  document.getElementById('upload-section').style.display='none';
  document.getElementById('quiz-section').style.display='none';
  el('quizFeedback').innerText='';
}

// События UI
el('nextBtn').onclick = loadNext;
el('checkBtn').onclick = checkAnswer;
el('showBtn').onclick = showTranslation;
el('showUpload').onclick = ()=>{ document.getElementById('upload-section').style.display='block'; document.getElementById('card-view').style.display='none'; };
el('uploadBtn').onclick = uploadList;
el('parseSampleBtn').onclick = aiParseAndUpload;
el('toQuizBtn').onclick = startQuiz;
el('quitQuiz').onclick = stopQuiz;
el('settingsBtn').onclick = async () => {
  // открываем диалог с ботом через sendData (можно перехватывать в n8n)
  await apiPost('openSettings', {});
  tg.sendData(JSON.stringify({action:'openSettings'}));
};
el('clearBtn').onclick = async ()=>{ await apiPost('clearCache'); setWordUI('Готово'); };

// старт
loadNext();
</script>
</body>
</html>